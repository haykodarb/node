<!DOCTYPE html>
<html lang="es">
<head>
	<link rel="shortcut icon" href="/favicon.ico" />
	<script src= "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.js"> </script>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Invernadero</title>
	<style>
		html {
			height: 100%;
		}

		body {
			background-color: #d7fff1;
			font-family: Arial, Helvetica, serif;
			min-height: 100vh;
			/* mobile viewport bug fix */
			min-height: -webkit-fill-available;
			position: relative;
		}

		h1 {
			background-color: #466d60;	
			padding: 8px 0;
			text-align: center;
			font-size: 40px;
			font-weight: 500;
			color: white;
			border-radius: 10px;
		}

		.container {
			display: flex;
			flex-direction: column;
			max-width: 600px;
			width: 100%;
			margin: 0 auto;
			text-align: left;
		}
		
		.botones {
			display: block;
			flex-direction: row;
			max-width: 1200px;
			height: 50px;
			width: 100%;
			margin: 0 auto;
			text-align: center;
		}
		.addOpacity {
			opacity: 0.5;
		}

		form > div {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 5px 0;
			height: 60px;
		}

		form > div > label {
			font-size: 20px;
			font-family: Arial, Helvetica, serif;
			background: #8cd790;
			color: black;
			font-weight: 500;
			width: 100%;
			height: 100%;
			display: flex;
			align-items: center;
			padding-left: 40px;
			border-top-left-radius: 5px;
			border-bottom-left-radius: 5px;
		}

		form > div > input {
			font-size: 16px;
			background: #aafcb8;
			color: black;
			height: 100%;
			padding: 0;
			text-align: center;
			font-weight: 600;
			border: none;
			border-top-right-radius: 5px;
			border-bottom-right-radius: 5px;
			width: 100%;
		}

		form input[type="submit"] {
			margin-top: 20px;
			padding: 10px;
		}

		form input[disabled] {
			background: #afafaf;
			cursor: not-allowed;
		}
		
		#loader {
			margin: auto;
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			font-size: 25px;
			width: 1.2em;
			height: 1.2em;
			border-radius: 50%;
			position: relative;
			text-indent: -9999em;
			-webkit-animation: load5 1.1s infinite ease;
			animation: load5 1.1s infinite ease;
			-webkit-transform: translateZ(0);
			-ms-transform: translateZ(0);
			transform: translateZ(0);
			display: none;
		}

		@-webkit-keyframes load5 {
			0%,
			100% {
				box-shadow: 0em -2.6em 0em 0em green, 1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2), 2.5em 0em 0 0em rgba(255, 255, 255, 0.2), 1.75em 1.75em 0 0em rgba(255, 255, 255, 0.2), 0em 2.5em 0 0em rgba(255, 255, 255, 0.2), -1.8em 1.8em 0 0em rgba(255, 255, 255, 0.2), -2.6em 0em 0 0em rgba(255, 255, 255, 0.5), -1.8em -1.8em 0 0em rgba(255, 255, 255, 0.7);
			}
			12.5% {
				box-shadow: 0em -2.6em 0em 0em rgba(255, 255, 255, 0.7), 1.8em -1.8em 0 0em green, 2.5em 0em 0 0em rgba(255, 255, 255, 0.2), 1.75em 1.75em 0 0em rgba(255, 255, 255, 0.2), 0em 2.5em 0 0em rgba(255, 255, 255, 0.2), -1.8em 1.8em 0 0em rgba(255, 255, 255, 0.2), -2.6em 0em 0 0em rgba(255, 255, 255, 0.2), -1.8em -1.8em 0 0em rgba(255, 255, 255, 0.5);
			}
			25% {
				box-shadow: 0em -2.6em 0em 0em rgba(255, 255, 255, 0.5), 1.8em -1.8em 0 0em rgba(255, 255, 255, 0.7), 2.5em 0em 0 0em green, 1.75em 1.75em 0 0em rgba(255, 255, 255, 0.2), 0em 2.5em 0 0em rgba(255, 255, 255, 0.2), -1.8em 1.8em 0 0em rgba(255, 255, 255, 0.2), -2.6em 0em 0 0em rgba(255, 255, 255, 0.2), -1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2);
			}
			37.5% {
				box-shadow: 0em -2.6em 0em 0em rgba(255, 255, 255, 0.2), 1.8em -1.8em 0 0em rgba(255, 255, 255, 0.5), 2.5em 0em 0 0em rgba(255, 255, 255, 0.7), 1.75em 1.75em 0 0em green, 0em 2.5em 0 0em rgba(255, 255, 255, 0.2), -1.8em 1.8em 0 0em rgba(255, 255, 255, 0.2), -2.6em 0em 0 0em rgba(255, 255, 255, 0.2), -1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2);
			}
			50% {
				box-shadow: 0em -2.6em 0em 0em rgba(255, 255, 255, 0.2), 1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2), 2.5em 0em 0 0em rgba(255, 255, 255, 0.5), 1.75em 1.75em 0 0em rgba(255, 255, 255, 0.7), 0em 2.5em 0 0em green, -1.8em 1.8em 0 0em rgba(255, 255, 255, 0.2), -2.6em 0em 0 0em rgba(255, 255, 255, 0.2), -1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2);
			}
			62.5% {
				box-shadow: 0em -2.6em 0em 0em rgba(255, 255, 255, 0.2), 1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2), 2.5em 0em 0 0em rgba(255, 255, 255, 0.2), 1.75em 1.75em 0 0em rgba(255, 255, 255, 0.5), 0em 2.5em 0 0em rgba(255, 255, 255, 0.7), -1.8em 1.8em 0 0em green, -2.6em 0em 0 0em rgba(255, 255, 255, 0.2), -1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2);
			}
			75% {
				box-shadow: 0em -2.6em 0em 0em rgba(255, 255, 255, 0.2), 1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2), 2.5em 0em 0 0em rgba(255, 255, 255, 0.2), 1.75em 1.75em 0 0em rgba(255, 255, 255, 0.2), 0em 2.5em 0 0em rgba(255, 255, 255, 0.5), -1.8em 1.8em 0 0em rgba(255, 255, 255, 0.7), -2.6em 0em 0 0em green, -1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2);
			}
			87.5% {
				box-shadow: 0em -2.6em 0em 0em rgba(255, 255, 255, 0.2), 1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2), 2.5em 0em 0 0em rgba(255, 255, 255, 0.2), 1.75em 1.75em 0 0em rgba(255, 255, 255, 0.2), 0em 2.5em 0 0em rgba(255, 255, 255, 0.2), -1.8em 1.8em 0 0em rgba(255, 255, 255, 0.5), -2.6em 0em 0 0em rgba(255, 255, 255, 0.7), -1.8em -1.8em 0 0em green;
			}
		}
		@keyframes load5 {
			0%,
			100% {
				box-shadow: 0em -2.6em 0em 0em green, 1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2), 2.5em 0em 0 0em rgba(255, 255, 255, 0.2), 1.75em 1.75em 0 0em rgba(255, 255, 255, 0.2), 0em 2.5em 0 0em rgba(255, 255, 255, 0.2), -1.8em 1.8em 0 0em rgba(255, 255, 255, 0.2), -2.6em 0em 0 0em rgba(255, 255, 255, 0.5), -1.8em -1.8em 0 0em rgba(255, 255, 255, 0.7);
			}
			12.5% {
				box-shadow: 0em -2.6em 0em 0em rgba(255, 255, 255, 0.7), 1.8em -1.8em 0 0em green, 2.5em 0em 0 0em rgba(255, 255, 255, 0.2), 1.75em 1.75em 0 0em rgba(255, 255, 255, 0.2), 0em 2.5em 0 0em rgba(255, 255, 255, 0.2), -1.8em 1.8em 0 0em rgba(255, 255, 255, 0.2), -2.6em 0em 0 0em rgba(255, 255, 255, 0.2), -1.8em -1.8em 0 0em rgba(255, 255, 255, 0.5);
			}
			25% {
				box-shadow: 0em -2.6em 0em 0em rgba(255, 255, 255, 0.5), 1.8em -1.8em 0 0em rgba(255, 255, 255, 0.7), 2.5em 0em 0 0em green, 1.75em 1.75em 0 0em rgba(255, 255, 255, 0.2), 0em 2.5em 0 0em rgba(255, 255, 255, 0.2), -1.8em 1.8em 0 0em rgba(255, 255, 255, 0.2), -2.6em 0em 0 0em rgba(255, 255, 255, 0.2), -1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2);
			}
			37.5% {
				box-shadow: 0em -2.6em 0em 0em rgba(255, 255, 255, 0.2), 1.8em -1.8em 0 0em rgba(255, 255, 255, 0.5), 2.5em 0em 0 0em rgba(255, 255, 255, 0.7), 1.75em 1.75em 0 0em green, 0em 2.5em 0 0em rgba(255, 255, 255, 0.2), -1.8em 1.8em 0 0em rgba(255, 255, 255, 0.2), -2.6em 0em 0 0em rgba(255, 255, 255, 0.2), -1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2);
			}
			50% {
				box-shadow: 0em -2.6em 0em 0em rgba(255, 255, 255, 0.2), 1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2), 2.5em 0em 0 0em rgba(255, 255, 255, 0.5), 1.75em 1.75em 0 0em rgba(255, 255, 255, 0.7), 0em 2.5em 0 0em green, -1.8em 1.8em 0 0em rgba(255, 255, 255, 0.2), -2.6em 0em 0 0em rgba(255, 255, 255, 0.2), -1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2);
			}
			62.5% {
				box-shadow: 0em -2.6em 0em 0em rgba(255, 255, 255, 0.2), 1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2), 2.5em 0em 0 0em rgba(255, 255, 255, 0.2), 1.75em 1.75em 0 0em rgba(255, 255, 255, 0.5), 0em 2.5em 0 0em rgba(255, 255, 255, 0.7), -1.8em 1.8em 0 0em green, -2.6em 0em 0 0em rgba(255, 255, 255, 0.2), -1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2);
			}
			75% {
				box-shadow: 0em -2.6em 0em 0em rgba(255, 255, 255, 0.2), 1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2), 2.5em 0em 0 0em rgba(255, 255, 255, 0.2), 1.75em 1.75em 0 0em rgba(255, 255, 255, 0.2), 0em 2.5em 0 0em rgba(255, 255, 255, 0.5), -1.8em 1.8em 0 0em rgba(255, 255, 255, 0.7), -2.6em 0em 0 0em green, -1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2);
			}
			87.5% {
				box-shadow: 0em -2.6em 0em 0em rgba(255, 255, 255, 0.2), 1.8em -1.8em 0 0em rgba(255, 255, 255, 0.2), 2.5em 0em 0 0em rgba(255, 255, 255, 0.2), 1.75em 1.75em 0 0em rgba(255, 255, 255, 0.2), 0em 2.5em 0 0em rgba(255, 255, 255, 0.2), -1.8em 1.8em 0 0em rgba(255, 255, 255, 0.5), -2.6em 0em 0 0em rgba(255, 255, 255, 0.7), -1.8em -1.8em 0 0em green;
			}
		}
		button {
			background-color: white;
			color:	#43695c;
			font-size: 18px;
			font-weight: 500;
			width: 20%;
			height: 100%;
			margin: 35px auto 0;
			border-radius: 15px;
			cursor: pointer;
			box-shadow: none;
		}
		button:hover{
			background-color: #43695c;
			color:	white;
		}
		button:focus {
  			outline: none;
		}
		button::-moz-focus-inner {
 			border: 0;
		}
		canvas {
			max-width: 1000px;
			width: 100%;
			display: block;
			margin: 45px auto 0;
			background-color: white;
		}
	</style>
</head>
<body>	
	<div class="container">
		<h1>Invernadero</h1>
		<form>
			<div>
				<label for="temperatura">Temperatura</label>
				<input type="text" id="temp" name="temp" value="" readonly>
			</div>	
			<div>
				<label for="humedad">Humedad</label>
				<input type="text" id="hum" name="hum" value="" readonly>
			</div>
			<div>
				<label for="luminosidad">Luminosidad</label>
				<input type="text" id="lum" name="lum" value="" readonly>
			</div>
			<div>
				<label for="hora">Hora</label>
				<input type="text" id="hora" name="hora" value="" readonly>
			
			</div>	
		</form>
	</div>
	<div class= "botones">
	<button type="button" id="botonHoy"	>Hoy</button>
	<button type="button" id="botonSemana"	>Últimos 7 días</button>
	<button type="button" id="botonMes" >Últimos 30</button>
	</div>
	<canvas id="myChart"></canvas>
</body>

<script>

let periodo = 'dia';
document.getElementById('botonDia').addEventListener("click", cambiarPeriodo('dia'));
document.getElementById('botonSemana').addEventListener("click", cambiarPeriodo('semana'));
document.getElementById('botonMes').addEventListener("click", cambiarPeriodo('mes'));

function cambiarPeriodo(per) {
periodo = per;
dataGraph(per);
}

function fijarHora() {
    let today = new Date();
    let min = today.getMinutes();
    let hora = today.getHours();
    if(min < 10) {
    min = `0${min}`;}
    document.getElementById('hora').setAttribute('value', `${hora}:${min}`);
}

function showLoader() {
    document.getElementById('loader').style.display = 'block';
    document.getElementsByClassName('container')[0].classList.add('addOpacity');
}

function hideLoader() {
    document.getElementById('loader').style.display = 'none';
    document.getElementsByClassName('container')[0].classList.remove('addOpacity');
}

function fetchData() { 
    fetch('https://kassen.now.sh/datos')
        .then(res => {
			return res.json();	
        })
        .then(json => {
			let temp = `${json.temp}°C`;
            let hum = `${json.hum}%`;
            let lum = `${json.lum}%`;
            document.getElementById('temp').setAttribute('value', `${temp}`);
            document.getElementById('hum').setAttribute('value', `${hum}`);
            document.getElementById('lum').setAttribute('value', `${lum}`);
		});
}

var ctx = document.getElementById('myChart').getContext('2d');
var chart = new Chart(ctx, {
	type: 'line',
	data: {
		labels: [],
		datasets: [{
			label: 'Temperatura',
			borderColor: 'rgb(255, 50, 50)',
			data: []
				},
			{
			label: 'Humedad',
			borderColor: 'rgb(0, 99, 132)',
			data: []
				},
			{
			label: 'Iluminación',
			borderColor: 'rgb(245, 233, 30)',
			data: []
			}]
		},
		// Configuration options go here
		options: {
			responsive: false,
			title: {
            display: true,
			text: 'Datos del día de hoy',
			fontSize: 20 
			},
			layout: {
            	padding: {
                	left: 20,
                	right: 20,
                	top: 20,
                	bottom: 20
            },
			scales: {
            	xAxes: [{
                	type: 'time',
                	time: {
                    		displayFormats: {
								minute: 'h:mm'
							}},
					distribution: 'linear',
					ticks: {
						source: 'auto',
						autoSkip: 'true',
						maxRotation: '5',
						padding: 2,
						},

            		}]
				}
			}
		}
	});



function dataGraph(periodo) {
	let url =`https://kassen.now.sh/graficos/${periodo}`; 
	fetch(url)
    .then(res => {
		return res.json();	
	})
	.then(json => {
		if(periodo === 'dia'){
		chart.data.labels = json.horaArray;}
		else {chart.data.labels = json.diaArray;}
		chart.data.datasets[0].data = json.tempArray;
		chart.data.datasets[1].data = json.humArray;
		chart.data.datasets[2].data = json.lumArray;
		chart.update();
	});
}

dataGraph(dia);
fijarHora();
fetchData();

function liveUpdate() { 
    setInterval( () => {
        fetchData();
        fijarHora();
		dataGraph(periodo);
	}, 60000)
}

document.addEventListener('DOMContentLoaded', () => {
    liveUpdate();
})


</script>

</html>